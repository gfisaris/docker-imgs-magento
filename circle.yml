machine:
  timezone:
    Europe/London
  services:
    - docker

dependencies:
  post:
    - docker info
    - docker build -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/my_app:$CIRCLE_SHA1 .
    - eval $(aws ecr get-login --region $AWS_REGION)
    - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/my_app:$CIRCLE_SHA1

deployment:
  ecr:
    branch: master
    commands:
      - chmod -R 755 ./circle-ci
      - ./circle-ci/push-docker_image-aws_ecr.sh
      - ./circle-ci/update-terraform-aws.sh
