machine:
  timezone:
    Europe/London
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker

checkout:
  post:
    - aws s3 cp s3://webapp-my-magento-eshop-appcode/$CIRCLE_BRANCH/app/etc/local.xml magento.local.xml

dependencies:
  pre:
    - sudo curl -o /usr/local/bin/ecs-cli https://s3.amazonaws.com/amazon-ecs-cli/ecs-cli-linux-amd64-latest
    - sudo chmod +x /usr/local/bin/ecs-cli
    - sudo pip install docker-compose

compile:
  pre:
    - if [[ $CIRCLE_BRANCH = "master" ]] ; then docker build -t 137115356293.dkr.ecr.eu-west-1.amazonaws.com/my_magento_eshop_appcode:$CIRCLE_BRANCH-$CIRCLE_SHA1 . ; fi
  post:
    - if [[ $CIRCLE_BRANCH = "master" ]] ; then sed "s/appcode:latest/appcode:$CIRCLE_BRANCH-$CIRCLE_SHA1/g" latest-dckcmp.yml > local-dckcmp.yml ; fi

test:
  pre:
    - eval $(aws ecr get-login --region eu-west-1)
    - if [[ $CIRCLE_BRANCH = "master" ]] ; then docker-compose -f local-dckcmp.yml up -d ; fi
    - if [[ $CIRCLE_BRANCH != "master" ]] ; then docker-compose -f latest-dckcmp.yml up -d ; fi
    -
  override:
    - if [[ $CIRCLE_BRANCH = "master" ]] ; then curl --retry 10 --retry-delay 5 127.0.0.1:$(docker-compose -f local-dckcmp.yml port my_magento_eshop_nginx 80 | cut -d ":" -f "2")/fpm_ping | grep "pingpong" ; fi
    - if [[ $CIRCLE_BRANCH != "master" ]] ; then curl --retry 10 --retry-delay 5 127.0.0.1:$(docker-compose -f latest-dckcmp.yml port my_magento_eshop_nginx 80 | cut -d ":" -f "2")/fpm_ping | grep "pingpong" ; fi
  post:
    - docker stop $(docker ps -a -q)
    - ecs-cli configure --profile default --region eu-west-1 --cluster mcboxes --compose-project-name-prefix mymagento_
    - ecs-cli ps
    - ecs-cli compose --project-name $CIRCLE_SHA1 -file latest-dckcmp.yml create

deployment:
  ecr:
    branch: master
    commands:
      - eval $(aws ecr get-login --region eu-west-1)
      - docker push 137115356293.dkr.ecr.eu-west-1.amazonaws.com/my_magento_eshop_appcode:$CIRCLE_BRANCH-$CIRCLE_SHA1
      - docker tag 137115356293.dkr.ecr.eu-west-1.amazonaws.com/my_magento_eshop_appcode:$CIRCLE_BRANCH-$CIRCLE_SHA1 137115356293.dkr.ecr.eu-west-1.amazonaws.com/my_magento_eshop_appcode:latest
      - docker push 137115356293.dkr.ecr.eu-west-1.amazonaws.com/my_magento_eshop_appcode:latest
      - aws ecs update-service --region eu-west-1 --cluster mcboxes --service my_magento_eshop --task-definition mymagento_$CIRCLE_SHA1 | jq -r '.service.taskDefinition' > taskDef.id
      - cat taskDef.id
      - aws ecs describe-services --region eu-west-1 --cluster mcboxes --service my_magento_eshop | jq ".services[].deployments[] | select(.taskDefinition | contains (\"$(cat taskDef.id)\")) | .desiredCount"
      - aws ecs describe-services --region eu-west-1 --cluster mcboxes --service my_magento_eshop | jq ".services[].deployments[] | select(.taskDefinition | contains (\"$(cat taskDef.id)\")) | .runningCount"
      - while [ $(aws ecs describe-services --region eu-west-1 --cluster mcboxes --service my_magento_eshop | jq ".services[].deployments[] | select(.taskDefinition | contains (\"$(cat taskDef.id)\")) | .desiredCount") != $(aws ecs describe-services --region eu-west-1 --cluster mcboxes --service my_magento_eshop | jq ".services[].deployments[] | select(.taskDefinition | contains (\"$(cat taskDef.id)\")) | .runningCount") ]; do echo "Service Updating still in progress.."; sleep 5; done
      - echo "All Done! Cya soon!"
